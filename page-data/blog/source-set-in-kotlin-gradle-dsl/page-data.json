{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/blog/source-set-in-kotlin-gradle-dsl/","result":{"data":{"site":{"siteMetadata":{"title":"Alan'space"}},"markdownRemark":{"id":"31f1bd98-0582-50af-aac3-e09f56a24524","fields":{"slug":"/blog/source-set-in-kotlin-gradle-dsl/"},"excerpt":"Gradle에서는 모듈 내에서도 소스셋을 나누어 사용할 수 있다. Intellij…","html":"<p>Gradle에서는 모듈 내에서도 소스셋을 나누어 사용할 수 있다. Intellij를 사용했을 때는 기본적으로는 다음과 같이 <code class=\"language-text\">main</code>, <code class=\"language-text\">test</code> 두 가지의 source set이 디폴트로 주어지지만, 상황에 따라 여분의 소스셋을 추가하고 싶을 때도 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 296px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3887c410a71dde00686efefc185d78b5/b1a44/main-and-test.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 106.32911392405065%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAABYlAAAWJQFJUiTwAAADfUlEQVR42o1VyXIiRxDlS+zLHHzyyZbYuml6X2hommZpphEgQKwCMVo8MozkmZglHI6Yi5eTLz75M58zS0KBB094Di+qqMp6WZnvVZNSdBO1VhtZWcHVTx+w/eVXBI0W+sMRuv0BioYl9nKF4hchlVdUFDRDHKo02mj1z2B5PoJaHX4YoaDqT4RfQpzaD5SLGtLZPDSnhLD1HJqiQCZCBifVbRd8gf8lZGSkAiq1higxaiW4+/Nv6NdvcHGxxuXND9je3ePtu/cI602k8zIkSs7kOxwQ7m6aISgKJYgSPJv+CFXToegG7JIP4/GGxzlJkDKOGY+/DwifiBl5CYV8HsPVNeLTMVg8yyvB9SsoBSG8SgCvHIhelypVVKOGaE3qs/2gm2QpYL15jcv794g7XayvrjAYjTGazDCZL9Dp9TGezbFYXWBCY+FzhFzWTqh0QUUmkxHBLNoRicZt4TJzNEqPsTscELI4qmmjXK0hLRfx9avf8dXlzwjiBO2kgxaBPXpCHmXlbbJYuRpCJTF12zkk5CzcCybl+TfJDM96S3jkyeSki6gZo04PodlOyBHmk50Mx4VuOf9dMpfBtshRuT413jQdUrGA7zM5UTKP36WzD0pLMo6ofG5B9lOVuXdcskaZAlKN1+4+/oHbzRJxHGG6WBHOMZ7OMZ2fi9L7gyGW5NUejQc9ZDJeZOKH7NRPx0e/kUPJUaBanrCNW64Iq5huScChNbbUv3zIRLxZUDU4QQ3DxRo+mdn1y/QUy3ArIR3yRMk7Q++S7uaCMCuR3IR0TqbDAfVPQ5We4Ivf/sLR5iPmVN7tZovtq3sSpSfi8tRbRo5csA/mSSmOgR1kS4Nsk8KETFjFt4MpVI9UdB0UPYv26P1aqhglk75SFLd/npGyGi6e0HRh1h34SYBmvwm7WoTxrgh1KyOettGZ9tCZdTFaj3G6HMJt+SJ+nyPFC/swIpsCS6h0Quh1G+qVhOLLHOJJG9MXc/QXAwyWI4xWY3hxWcTvyPj8AeEuo0lkZt1FcPIcXjOCGlooVqkdVUOMSqBBC03oNYv2TDF/IGwQyR70uiVKbp0lsCMLmw8vcf1miR6VPL9ZEZaYX59jcXOOs/WEMMbqdo3hxRgGXSJlhDY+hRXxDUvwAwMnvWPMFhIp7KHWo7+IAT270zbiUYKwWyc0EA8TRL2mOPsPLOsXEQ+3kOkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"main and test source sets\"\n        title=\"\"\n        src=\"/static/3887c410a71dde00686efefc185d78b5/b1a44/main-and-test.png\"\n        srcset=\"/static/3887c410a71dde00686efefc185d78b5/c26ae/main-and-test.png 158w,\n/static/3887c410a71dde00686efefc185d78b5/b1a44/main-and-test.png 296w\"\n        sizes=\"(max-width: 296px) 100vw, 296px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>나는 유닛 테스트와 통합 테스트를 서로 다른 소스셋으로 구분하고 싶어서 기존의 <code class=\"language-text\">test</code>는 그대로 둔 채로 <code class=\"language-text\">integrationTest</code>라는 소스셋을 새로 추가했다. <code class=\"language-text\">build.gradle.kts</code>에서 아래와 같이 새로운 소스셋을 추가할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">// Create a new sourceSet for integration tests</span>\nsourceSets <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"integrationTest\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        java <span class=\"token punctuation\">{</span>\n            compileClasspath <span class=\"token operator\">+=</span> main<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>output <span class=\"token operator\">+</span> test<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>output\n            runtimeClasspath <span class=\"token operator\">+=</span> main<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>output <span class=\"token operator\">+</span> test<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>output\n            <span class=\"token function\">srcDir</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"src/integrationTest/kotlin\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">val</span> integrationTestImplementation <span class=\"token keyword\">by</span> configurations<span class=\"token punctuation\">.</span><span class=\"token function\">getting</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">extendsFrom</span><span class=\"token punctuation\">(</span>configurations<span class=\"token punctuation\">.</span>testImplementation<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\nconfigurations<span class=\"token punctuation\">[</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"integrationTestRuntimeOnly\"</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">extendsFrom</span><span class=\"token punctuation\">(</span>configurations<span class=\"token punctuation\">.</span>testRuntimeOnly<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>여기서 주목할 만한 부분은 <code class=\"language-text\">classpath</code>를 설정하는 부분이다. 기존에 테스트를 작성할 때는 별도의 설정 없이 <code class=\"language-text\">main</code> 소스셋의 클래스들을 가져다 사용할 수 있었다. 이는 <code class=\"language-text\">test</code> 소스셋에서 <code class=\"language-text\">main</code>의 클래스패스를 참조하기 때문에 그렇다. 마찬가지로 <code class=\"language-text\">integrationTest</code>에서도 테스트를 위한 디펜던시들에 접근해야 하기 때문에 <code class=\"language-text\">test</code>의 빌드 결과를 새로운 소스셋의 클래스패스에 추가해주었다.</p>\n<p><a href=\"https://docs.gradle.org/current/dsl/org.gradle.api.tasks.SourceSetOutput.html\">공식 문서</a>에서 SourceSet의 output에 대한 설명을 찾을 수 있다.</p>\n<blockquote>\n<p>A collection of all output directories (compiled classes, processed resources, etc.) - notice that SourceSetOutput extends FileCollection.</p>\n</blockquote>\n<p>여기까지 작성했다면 IDE의 파일 트리에 새로운 소스셋이 추가된 것을 확인할 수 있다. 그런데 Intellij가 해당 소스셋을 테스트 소스셋으로 인식하지 않는다.</p>\n<p>이를 위해서는 idea 플러그인을 추가하고, <code class=\"language-text\">testSourceDirs</code>에 새로 추가한 소스셋을 등록하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">plugins <span class=\"token punctuation\">{</span>\n    idea\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Register integrationTest sourceSet as a test sourceSet.</span>\nidea<span class=\"token punctuation\">.</span><span class=\"token function\">module</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> testSources <span class=\"token operator\">=</span> testSourceDirs\n    testSources<span class=\"token punctuation\">.</span><span class=\"token function\">addAll</span><span class=\"token punctuation\">(</span>project<span class=\"token punctuation\">.</span>sourceSets<span class=\"token punctuation\">.</span><span class=\"token function\">getByName</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"integrationTest\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">.</span>srcDirs<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// This line is redundant, but I just keep it as a reference.</span>\n    testSources<span class=\"token punctuation\">.</span><span class=\"token function\">addAll</span><span class=\"token punctuation\">(</span>project<span class=\"token punctuation\">.</span>sourceSets<span class=\"token punctuation\">.</span><span class=\"token function\">getByName</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"integrationTest\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>resources<span class=\"token punctuation\">.</span>srcDirs<span class=\"token punctuation\">)</span>\n    testSourceDirs <span class=\"token operator\">=</span> testSources\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 286px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a53c37a0a88681b319ec85f78714b5bc/357e3/test-source-set.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82.91139240506328%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAADAElEQVR42o2USVNbRxRG9UOSZfbJAmPEoDdPfprnEQ0ga0BCSAILMIjBpLxzqrJwUpVKNvmfJ/c1ZSoOKduLo77d/fXt26r7vZjtv2LPMHFTWbqjYzJhiB8mcYOQIJXG8gJ028V0fQzHI1Mo4oUpNMumUK5QqtXVvidnLNHEUtkCCcMWYYX173+zuf6VyXzJ+cUll1fXPPz8npvbOy4u3/L2as365o6bu3vmy1Ourm/U2tnqgrt3D5SqdWI7ls6ubaI5JtvpND9MLjGCAMNy0T0XO+lTbtVlTea+o7BC2Q88iV21bkpshT6a5xBzSwFO0cOvJMnv5wlCDWuhY6wShJ0kxXaZdDNH+aBGY9gi1chi5eUiOWMXPscpypOjn2jyqpqiJIesXIB1oaN/iJM+SrNYnXJ8fsLh7DXzyyXto67SPxbiPyP274mZc9TolgPMvKMqUdUU/Kc4Wo90ZhTnHjXPEn6qMHqWkbUYnq84WV9T6JapHtaFhlCT/aqi1m9QEW2t3yS3X3x6rkroliQoeQTVkHy3hJPzWR45nN5nmY1TdGdDpuczhsuxYrI6pnt8SH8+YLqa0Rq1JaFLlCcipvk2Cc9CD5zHUdCsLQx/E9vdYcvUiJsJtMBGaX3rSR/N/4vqwz3NJF2scvvLbxQ6A6qNNgf9MfVWl8l0RqfXZ3N7j/iu9lVibpBkRzPwxBn11S3fv/uTZu+QwXDEZCZPPZrQ6w/Y2k2wndC/SiwSxvc0sZ88x/bYckNeSDU/bbzkx41NNuI7vBC+JZlKmCtVMMSLmXKNh49/UXg95WAwZDZfMD2Zy7hkVzfVpd+UMCEmj2s6jueTn57x3f0f5Ep12p0e7d4Bjf22+kviCU2xLdovETMz0rBZ8aKMRtrByCdJ1HT28hpa0lJE+15RvkKl5KP2C8Qc6Z3Il2EjQ1N6yhPr2fcaxseXZGfSi28WjM8mDBYjFlen7I87WKJ3VP8+5zPrKX/m5YKuWGpk4jcD5ZKKuCVyRLlXJdPK/6+HPznlHxv2lLBbgBUnAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"recognize as test source set\"\n        title=\"\"\n        src=\"/static/a53c37a0a88681b319ec85f78714b5bc/357e3/test-source-set.png\"\n        srcset=\"/static/a53c37a0a88681b319ec85f78714b5bc/c26ae/test-source-set.png 158w,\n/static/a53c37a0a88681b319ec85f78714b5bc/357e3/test-source-set.png 286w\"\n        sizes=\"(max-width: 286px) 100vw, 286px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>마지막으로 해결해야 하는 문제는 새로 만든 소스셋에서 main이 아닌 다른 소스셋(가령 test)의 코드를 가져다쓸 수 있게 하는 것이다. 지금 이대로 사용할 경우 유닛 테스트에서 만든 테스트 데이터를 <code class=\"language-text\">integrationTest</code> 소스셋에서는 사용할 수 없다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">task(\"integrationTest\", Test::class) {\n    testClassesDirs = sourceSets[\"integrationTest\"].output\n    classpath = sourceSets[\"integrationTest\"].runtimeClasspath\n}\n\n\nval integrationTestImplementation: Configuration by configurations.getting {\n    extendsFrom(configurations.testImplementation.get())\n}\n\nconfigurations {\n    getByName(\"integrationTestRuntimeOnly\") {\n        extendsFrom(configurations.testRuntimeOnly.get())\n    }\n}</code></pre></div>\n<h3>References</h3>\n<ul>\n<li><a href=\"https://docs.gradle.org/current/userguide/java_testing.html#sec:configuring_java_integration_tests\">https://docs.gradle.org/current/userguide/java_testing.html#sec:configuring_java_integration_tests</a></li>\n<li><a href=\"https://rio-kim.github.io/testing/2017/12/20/gradle_test_sourceset_config/\">https://rio-kim.github.io/testing/2017/12/20/gradle_test_sourceset_config/</a></li>\n</ul>","frontmatter":{"date":"2022-02-27","title":"Gradle 프로젝트에 새로운 Source Set 추가하기 (with Kotlin Gradle DSL)","description":"용도에 따라 소스를 분리해서 관리하고 싶다면!","category":"blog","tags":["kotlin","gradle","intellij"]}},"previous":{"fields":{"slug":"/snippets/pandas-cheatsheet/"},"frontmatter":{"title":"Pandas Cheatsheet"}},"next":{"fields":{"slug":"/blog/study-plan-2022/"},"frontmatter":{"title":"2022년 공부 계획"}}},"pageContext":{"id":"31f1bd98-0582-50af-aac3-e09f56a24524","category":"blog","tags":["kotlin","gradle","intellij"],"previousPostId":"7fe66fb2-b94b-537e-843d-2b363b92aaee","nextPostId":"2a54785a-d522-56ed-86bf-7d277337eef3"}},"staticQueryHashes":["2447914076"],"slicesMap":{}}